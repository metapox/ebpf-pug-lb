# システムアーキテクチャ設計

## 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    User Space                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Control API   │  │  Configuration  │  │  Statistics │ │
│  │   (REST/CLI)    │  │    Manager      │  │   Collector │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│           │                     │                    │     │
│           └─────────────────────┼────────────────────┘     │
│                                 │                          │
├─────────────────────────────────┼──────────────────────────┤
│                    Kernel Space │                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                TC eBPF Program                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   Packet    │  │   Client    │  │   Rate Limit    │ │ │
│  │  │   Parser    │  │   Extractor │  │    Enforcer     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│           │                     │                    │     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   eBPF Maps                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   Client    │  │    Rate     │  │    Statistics   │ │ │
│  │  │   Config    │  │   Buckets   │  │      Data       │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### User Space
- **Control API**: 設定変更、統計取得のためのインターフェース
- **Configuration Manager**: レート制御ポリシーの管理
- **Statistics Collector**: カーネルからの統計情報収集・集約

### Kernel Space (eBPF)
- **Packet Parser**: HTTP/HTTPSパケットの解析
- **Client Extractor**: Client-ID、APIキー等の識別子抽出
- **Rate Limit Enforcer**: Token Bucket/Leaky Bucketによる制御

### eBPF Maps
- **Client Config**: クライアント別設定 (rate limit, priority)
- **Rate Buckets**: Token/Leaky Bucket状態管理
- **Statistics Data**: リアルタイム統計情報

## データフロー

1. **パケット受信** → TC hook point
2. **HTTP解析** → Header parsing (Client-ID抽出)
3. **レート判定** → Bucket algorithm check
4. **アクション決定** → PASS/DROP/THROTTLE
5. **統計更新** → Maps update
6. **パケット転送** → 次のネットワークスタックへ
